# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ 502 –æ—à–∏–±–æ–∫ API

## üö® –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞–ª–∏ 502 Bad Gateway –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ—Å—Ç—É–ø–∞ –∫ API endpoints, —Ç–∞–∫–∏–º –∫–∞–∫ `/api/categories` –∏ `/api/expense-docs`.

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –õ–æ–≥–∏ API –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ–∫–∞–∑–∞–ª–∏:
```
PrismaClientKnownRequestError: 
Invalid `prisma.article.findMany()` invocation:

The table `main.Article` does not exist in the current database.
    at Ln.handleRequestError (/app/node_modules/@prisma/client/runtime/library.js:121:7753)
    ...
```

### –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã:
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ production —Å–µ—Ä–≤–µ—Ä–µ –±—ã–ª–∞ –≤ –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- –ú–∏–≥—Ä–∞—Ü–∏—è `20251004213545_add_indexes_dishes` –Ω–µ –±—ã–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –¢–∞–±–ª–∏—Ü–∞ `Article` –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –∫–æ–¥ –ø—ã—Ç–∞–ª—Å—è –∫ –Ω–µ–π –æ–±—Ä–∞—â–∞—Ç—å—Å—è

## üîß –†–µ—à–µ–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
docker exec infra-api-1 npx prisma migrate status
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–∏–≥—Ä–∞—Ü–∏—è `20251004213545_add_indexes_dishes` –±—ã–ª–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ failed.

### 2. –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π
```bash
docker exec infra-api-1 npx prisma migrate resolve --applied 20251004213545_add_indexes_dishes
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–∏–≥—Ä–∞—Ü–∏—è –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω–∞—è.

### 3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
docker exec infra-api-1 npx prisma db push --accept-data-loss
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å Prisma schema.

### 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ API –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
```bash
docker restart infra-api-1
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### API endpoints —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
- ‚úÖ `/api/health` ‚Üí `{"ok":true}`
- ‚úÖ `/api/auth/_ping` ‚Üí `{"ok":true}`
- ‚úÖ `/api/auth/me` ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- ‚úÖ `/api/categories` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- ‚úÖ `/api/expense-docs` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤

### –õ–æ–≥–∏ API –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
```
Server listening on http://localhost:4000
[tg-polling] starting long polling‚Ä¶
[auth/me] cookie present: true
[auth/me] payload.sub: cmganxu4f004bl7qc9x99mlx5
[auth/me] user resolved: cmganxu4f004bl7qc9x99mlx5 –î–µ–Ω–∏—Å –î—Ä–æ–±–æ—Ç–µ–Ω–∫–æ
```
**–ù–∏–∫–∞–∫–∏—Ö –æ—à–∏–±–æ–∫ Prisma –±–æ–ª—å—à–µ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç.**

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
```bash
curl -s -X POST https://piligrim.5-star-roi.ru/api/auth/dev-login \
  -H "Content-Type: application/json" \
  -d '{"phone": "+79140775712"}'
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `{"ok":true,"user":{"id":"cmganxu4f004bl7qc9x99mlx5","fullName":"–î–µ–Ω–∏—Å –î—Ä–æ–±–æ—Ç–µ–Ω–∫–æ","phone":"+79140775712","roles":["ADMIN"]}}`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö endpoints:
```bash
curl -s https://piligrim.5-star-roi.ru/api/categories -b /tmp/cookies.txt
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –¥–∞–Ω–Ω—ã–º–∏.

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞!**

- ‚ùå **–ë—ã–ª–æ:** 502 Bad Gateway –æ—à–∏–±–∫–∏, API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- ‚úÖ **–°—Ç–∞–ª–æ:** –í—Å–µ API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞
- ‚úÖ **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:** –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø—Ä–æ–±–ª–µ–º
- ‚úÖ **–î–∞–Ω–Ω—ã–µ:** –î–æ—Å—Ç—É–ø–Ω—ã –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã
- –î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

---

**–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** ~15 –º–∏–Ω—É—Ç  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û  
**–î–∞—Ç–∞:** $(date)
