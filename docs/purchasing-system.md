# Система закупа

## Обзор

Система закупа автоматизирует процесс планирования и формирования заказов поставщикам на основе данных о расходе продуктов и текущих остатках.

## Основные функции

### 1. Расчет заказов
- Автоматический расчет количества к заказу на основе:
  - Расхода продуктов за последние 4 недели (данные из iiko)
  - Буферных запасов для каждого продукта
  - Текущих остатков на складах
- Формула: `К заказу = Буферный запас - Текущий остаток`
- Если результат отрицательный, заказ не создается

### 2. Управление буферными запасами
- Настройка буферных запасов для каждого продукта
- Параметры:
  - Количество дней буфера (по умолчанию 7)
  - Минимальный буфер
  - Максимальный буфер
- Автоматический расчет буфера: `Расход за неделю × (Дни буфера / 7)`

### 3. Управление поставщиками
- Связывание продуктов с поставщиками
- Настройка приоритетов (основной/запасной)
- Параметры поставщика:
  - Минимальная сумма заказа
  - Дни доставки
  - Цена (опционально)
  - Единица измерения

### 4. Синхронизация с iiko
- Автоматическая синхронизация остатков продуктов
- Получение данных о расходе через iiko OLAP API
- Кэширование данных для оптимизации производительности

### 5. Управление заказами
- Создание заказов поставщикам
- Отслеживание статусов заказов
- История заказов

## API Endpoints

### Расчет заказов
- `GET /api/purchasing/calculate-orders` - Расчет заказов
- `POST /api/purchasing/orders` - Создание заказа

### Буферы
- `GET /api/purchasing/buffers` - Список буферов
- `POST /api/purchasing/buffers` - Создание буфера
- `PUT /api/purchasing/buffers/:id` - Обновление буфера
- `DELETE /api/purchasing/buffers/:id` - Удаление буфера

### Поставщики продуктов
- `GET /api/purchasing/product-suppliers` - Список поставщиков
- `POST /api/purchasing/product-suppliers` - Создание связи
- `PUT /api/purchasing/product-suppliers/:id` - Обновление связи
- `DELETE /api/purchasing/product-suppliers/:id` - Удаление связи

### Остатки
- `GET /api/purchasing/stocks` - Получение остатков
- `POST /api/purchasing/sync-stocks` - Синхронизация с iiko

### Заказы
- `GET /api/purchasing/orders` - Список заказов
- `PUT /api/purchasing/orders/:id/status` - Изменение статуса

## Модели данных

### ProductBuffer
Буферные запасы для продуктов:
- `productId` - ID продукта из iiko
- `bufferDays` - Дни буфера
- `minBuffer` - Минимальный буфер
- `maxBuffer` - Максимальный буфер

### ProductSupplier
Связь продукт-поставщик:
- `productId` - ID продукта
- `supplierId` - ID поставщика (Counterparty)
- `isPrimary` - Основной поставщик
- `priority` - Приоритет среди запасных
- `deliveryDays` - Дни доставки
- `price` - Цена за единицу

### ProductStock
Остатки продуктов:
- `productId` - ID продукта
- `storeId` - ID склада
- `currentStock` - Текущий остаток
- `lastSyncWithIiko` - Время последней синхронизации

### SupplierOrder
Заказы поставщикам:
- `supplierId` - ID поставщика
- `status` - Статус заказа
- `scheduledDate` - Планируемая дата
- `totalAmount` - Общая сумма

## Алгоритм работы

1. **Сбор данных**:
   - Получение списка продуктов с настроенными буферами
   - Расчет расхода за последние 4 недели через iiko OLAP
   - Получение текущих остатков из iiko

2. **Расчет буферного запаса**:
   ```
   Буферный запас = max(Минимальный буфер, min(Максимальный буфер, Расход за неделю × (Дни буфера / 7)))
   ```

3. **Расчет количества к заказу**:
   ```
   К заказу = max(0, Буферный запас - Текущий остаток)
   ```

4. **Группировка по поставщикам**:
   - Выбор основного поставщика для каждого продукта
   - Группировка позиций по поставщикам
   - Создание заказов

## Интеграция с iiko

### Получение расхода
Используется iiko OLAP API с запросом:
```json
{
  "reportType": "TRANSACTIONS",
  "groupByRowFields": ["Product.Id", "Product.Name"],
  "aggregateFields": ["Amount"],
  "filters": {
    "DateTime.Typed": {
      "filterType": "DateRange",
      "periodType": "CUSTOM",
      "from": "2024-01-01T00:00:00.000",
      "to": "2024-01-28T00:00:00.000"
    },
    "Product.Id": {
      "filterType": "IncludeValues",
      "values": ["product-id"]
    }
  }
}
```

### Получение остатков
Используется метод `getStoresBalances()` iiko клиента для получения актуальных остатков.

## Настройка

1. **Создание буферов**:
   - Перейти в раздел "Буферы"
   - Добавить буфер для каждого продукта
   - Настроить параметры буфера

2. **Настройка поставщиков**:
   - Перейти в раздел "Поставщики"
   - Связать продукты с поставщиками
   - Настроить приоритеты и параметры

3. **Синхронизация данных**:
   - Перейти в раздел "Остатки"
   - Нажать "Синхронизировать с iiko"
   - Проверить актуальность данных

## Использование

1. **Расчет заказов**:
   - Перейти в раздел "Расчет"
   - Нажать "Рассчитать заказы"
   - Проверить результаты расчета
   - Нажать "Создать заказы" для формирования заказов

2. **Управление заказами**:
   - Перейти в раздел "Заказы"
   - Просмотреть историю заказов
   - Изменить статусы заказов

## Требования

- Доступ к iiko API
- Настроенные буферы для продуктов
- Связанные поставщики для продуктов
- Права доступа `iiko.read` и `iiko.manage`
