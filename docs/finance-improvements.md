### Финансовый модуль — обзор, стандарты и чек‑лист доработок

Краткий консолидационный документ по текущему состоянию финмодуля и приоритетным улучшениям. Актуален для связки: сервер (Express + Prisma + SQLite) и клиент (Next.js 14, shadcn/ui).

### 1) Обзор текущего состояния
- Сервер реализует учет: Accounts, Categories, Counterparties, Transactions (income/expense/transfer/adjustment), а также связь с HR-блоком (Payout → Transaction) и отчеты: ДДС (cashflow) и ОПиУ (pnl).
- Клиент покрывает: список операций, фильтры по периоду/счету/категории/деятельности, создание доходов/расходов/переводов, отчеты ДДС/ОПиУ.
- Документация содержит планы по сверке и интеграциям, но часть описаний (Next API, Postgres) не совпадает с фактической архитектурой (отдельный Express, SQLite).

### 2) Стандартизация модели данных и справочников
- Ввести Prisma enum’ы вместо строк:
  - Transaction.kind: 'expense' | 'income' | 'transfer' | 'adjustment'
  - Transaction.activity: 'OPERATING' | 'INVESTING' | 'FINANCING'
  - Transaction.method: 'cash' | 'card' | 'bank' (при необходимости)
  - Category.type: 'expense' | 'income'
  - Account.kind: унифицировать (например, 'cash' | 'card' | 'bank' | 'safe')
- Привести фактические значения к справочнику (в сидере встречается 'noncash' — заменить на выбранный вариант).
- Денежные суммы хранить целыми копейками (беззнаковые), знак определять из kind/контекста отображения.

### 3) Переводы и модель проводок
- API сейчас возвращает переводы как две независимые Transaction (минус/плюс по разным счетам). Для UX и аналитики полезно:
  - Возвращать агрегированный объект Transfer в GET, включающий fromAccountId/toAccountId и сумму; либо
  - Ввести «двухсторонние» ledger‑проводки (debit/credit) как общую модель на будущее.
- UI «Переводы»: показывать корректно поля «Из» и «В», а не дублировать accountId.

### 4) Отчеты: ДДС и ОПиУ — производительность и корректность
- Перенести фильтрацию по периоду и типам из JS в запросы БД, особенно для ОПиУ (использовать where по accrualYear/accrualMonth, fallback на paymentDate).
- Добавить индексы: Transaction(kind), Transaction(accountId), Transaction(categoryId), при необходимости (activity). Уже есть индексы по paymentDate и (accrualYear, accrualMonth).

### 5) Наследование activity
- При создании expense/income, если activity не задано, подставлять и сохранять его из Category.activity. Это стабилизирует отчеты и фильтры без лишних вычислений.
- При переносе транзакций между категориями контролировать совместимость type и, желательно, activity.

### 6) Контракты API, валидация и пагинация
- Унифицировать ответы: либо везде { data: ... }, либо { items: ... }.
- Внедрить Zod‑валидацию входов во всех эндпоинтах и единый формат ошибок.
- Добавить пагинацию/сортировку в GET /api/transactions (и при необходимости в другие списки).

### 7) Балансы и сверка
- Реализовать модели Statement/StatementLine, эндпоинты импорта/сопоставления и отчет по расхождениям.
- Эндпоинт для расчетных остатков по счетам на дату/период: GET /api/accounts/balances?y&m.

### 8) Выплаты и атомарность
- Завернуть создание Payout и связанной Transaction(expense «Зарплата») в одну prisma.$transaction для атомарности.

### 9) Справочники и статусы
- Account.active (архивация/мягкое удаление), аналогично Category.active.
- Counterparty.kind — enum с валидацией (person/company/bank/other).

### 10) Безопасность и мультиарендность
- Базовая аутентификация/авторизация на сервере, ограничение CORS.
- tenantId не определять через «первый/создать Default», а брать из контекста auth (мультиарендность).
- Аудит: кто/когда создал/изменил, логирование ключевых операций.

### 11) UI/UX доработки
- Transactions (вкладка «Переводы») — вывод парных полей «Из/В» и корректные названия/фильтры.
- Categories — диалог переноса транзакций при удалении с валидацией type/activity.
- Единый форматтер для денег и дат, переиспользование в отчетах и списках.

### 12) Технический долг
- Убрать обращения через (prisma as any) после миграций и генерации клиента, включить строгие типы.
- Привести названия параметров API к единому стилю (camelCase в JSON/query), документировать.
- E2E‑тесты базовых сценариев (создание расхода, перевод, отчеты).

### Чек‑лист доработок (по приоритетам)

— База данных и схема (высокий приоритет)
- [x] Стандартизировать значения через String + Zod (SQLite вместо enum)
- [x] Миграция значений Account.kind (устранить 'noncash', привести к справочнику)
- [x] Добавить индексы: Transaction(kind), Transaction(accountId), Transaction(categoryId)

— Транзакции и переводы (высокий приоритет)
- [x] GET /api/transactions: возвращать агрегированный Transfer (from/to/amount) или ввести ledger‑модель
- [x] UI «Переводы»: показывать «Из/В» корректно, без дублирования accountId

— Отчеты и производительность (высокий приоритет)
- [x] Перенести фильтры периода/типов в where Prisma для ОПиУ
- [x] Проверить корректность ДДС: исключение transfer из агрегатов, группировки по activity/account

— Наследование activity (средний приоритет)
- [x] При POST expense/income — автоподстановка и сохранение Category.activity
- [x] При переносе транзакций — запрет несогласованных type/activity

— Контракты API и UX списков (средний приоритет)
- [x] Унифицировать формат ответов ({ data } | { items }) и ошибки
- [x] Добавить пагинацию и сортировку в GET /api/transactions
- [x] Везде добавить Zod‑валидацию входов

— Балансы и сверка (средний приоритет)
- [x] Добавить модели Statement/StatementLine, эндпоинты импорта/сопоставления
- [x] GET /api/accounts/balances?y&m — расчет остатков и движения

— Выплаты и атомарность (средний приоритет)
- [x] Обернуть Payout + создание Transaction(expense «Зарплата») в prisma.$transaction

— Справочники и статусы (средний приоритет)
- [x] Account.active + мягкое удаление/архивирование
- [x] Counterparty.kind — валидация на входе (Zod enum)

— Безопасность и мультиарендность (средний/долгосрочный)
- [x] Добавить аутентификацию/роли (заголовок x-role) и ограничить CORS (ALLOWED_ORIGINS)
- [x] tenantId брать из контекста запроса (заголовок x-tenant-id; убран «Default tenant» по умолчанию в код-пути создания)
- [x] Аудит полей createdBy/updatedBy (из заголовка x-user-id)

— Технический долг (плановый)
- [x] Убрать (prisma as any), включить строгие типы TS (фин‑модули)
- [x] Привести query‑параметры к единому стилю и документировать (from/to → startDate/endDate)

### Примечания по архитектуре документации
- Документацию синхронизировать с фактической архитектурой (отдельный Express‑сервер и SQLite). В тексте system.md упомянут Next API и Postgres — уточнить и/или предложить дорожную карту перехода.


