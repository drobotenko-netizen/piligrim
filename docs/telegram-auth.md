# Система авторизации через Telegram бота

## Обзор

Система авторизации в Piligrim работает через Telegram бота. Пользователи входят в систему через команду `/login` в боте, получают magic link и переходят по нему для авторизации.

## Процесс авторизации

### 1. Создание пользователя (Администратор)

1. Администратор создает пользователя в системе
2. Генерируется код привязки для Telegram бота
3. Пользователю отправляется ссылка: `https://t.me/piligrim_app_bot?start=<код_привязки>`

### 2. Привязка аккаунта (Пользователь)

1. Пользователь переходит по ссылке или находит бота `@piligrim_app_bot`
2. Отправляет команду `/start <код_привязки>`
3. Бот подтверждает привязку аккаунта

### 3. Вход в систему (Пользователь)

1. Пользователь отправляет команду `/login` в боте
2. Бот генерирует magic link (действует 15 минут)
3. Пользователь переходит по ссылке
4. Автоматически авторизуется в веб-приложении

## Технические детали

### API Endpoints

- `POST /api/auth/magic/issue` - генерация magic link (только для админов)
- `GET /api/auth/magic/callback` - обработка magic link
- `GET /api/auth/magic/s/:id` - короткая ссылка для magic link

### Telegram Bot Commands

- `/start <код>` - привязка аккаунта
- `/login` - получение ссылки для входа
- `/help` - справка по командам

### Переменные окружения

```bash
TELEGRAM_BOT_TOKEN=8466721340:AAGaA3Y1nozm5YLTP_F2ChpyCQdDktyF6_0
TELEGRAM_BOT_USERNAME=piligrim_app_bot
TELEGRAM_POLLING=1
MAGIC_LINK_SECRET=please-change-this-too
SERVER_PUBLIC_URL=https://piligrim.5-star-roi.ru
FRONTEND_BASE_URL=https://piligrim.5-star-roi.ru
```

### База данных

- `TelegramBinding` - привязки пользователей к Telegram чатам
- `TelegramBindRequest` - запросы на привязку (с TTL)
- `MagicLinkToken` - токены для magic links

## Безопасность

- Magic links действуют 15 минут
- Коды привязки действуют 24 часа
- Все токены одноразовые
- Поддержка домена `.5-star-roi.ru` для cookies

## Устранение неполадок

### Пользователь не может войти

1. Проверить, что аккаунт привязан к боту
2. Убедиться, что бот отвечает на команды
3. Проверить, что magic link не истек

### Бот не отвечает

1. Проверить `TELEGRAM_BOT_TOKEN`
2. Убедиться, что `TELEGRAM_POLLING=1`
3. Проверить логи API контейнера

### Magic link не работает

1. Проверить `SERVER_PUBLIC_URL` и `FRONTEND_BASE_URL`
2. Убедиться, что домен настроен правильно
3. Проверить, что токен не истек
