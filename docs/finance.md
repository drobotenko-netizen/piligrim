# Финансы — проект и чек-лист

## Цели
- Единый учет денег по всем счетам (касса/сейф/карта/р/счета), доходам/расходам, переводам.
- Разделение «когда заплатили» (ДДС) и «когда начислили» (ОПиУ). 
- Сверка остатков счетов и выписок, прозрачность движения по видам деятельности.

## Виды деятельности (Activity)
Для классификации денежных потоков и отчетности по ДДС вводятся три вида деятельности:
- Операционная (OPERATING): повседневная деятельность кафе — выручка, закупки, зарплаты, аренда, коммунальные и т.п.
- Инвестиционная (INVESTING): покупка/продажа долгосрочных активов, капитальные ремонты, оборудование.
- Финансовая (FINANCING): заемные/собственные средства, кредиты, вклады/изъятия собственников, проценты банку.

Рекомендации по моделированию:
- Поле `activity` задается у `Category` (категории доходов/расходов). Это упрощает классификацию транзакций (по умолчанию транзакция наследует `activity` категории).
- Разрешить переопределение `activity` на уровне конкретной транзакции (редкий кейс: ошибочная категория или разовые операции).

## Данные (MVP)
- Account (счет): имя, тип (cash/safe/card/bank), активность, валюта (RUB), начальный остаток, дата открытия.
- Category (категория): тип (expense|income), иерархия (parentId), `activity: OPERATING|INVESTING|FINANCING`, активность.
- Transaction (транзакция):
  - `kind`: expense | income | transfer | adjustment
  - `paymentDate`
  - `accrualYear`, `accrualMonth` (период начисления для ОПиУ)
  - `accountId` (для expense/income/adjustment)
  - `fromAccountId`, `toAccountId` (для transfer)
  - `categoryId` (для expense/income)
  - `activity` (nullable) — опциональный оверрайд; если пусто, берется из категории
  - `method`: cash | card | bank (опц.)
  - `amountCents`, `note`, `counterparty` (опц.), `source` (модуль: payroll/iiko/ручная)
- Reconciliation (сверка) — этап 2:
  - Statement: accountId, период, opening/closing, источник (файл/ручной), статус.
  - StatementLine: дата, сумма, описание, externalId, matchedTransactionId (nullable), status.

Связи с существующими модулями:
- `Payout` (выплаты сотрудникам) → при создании формируем связанную `Transaction` (expense, категория «Зарплата», activity: OPERATING).
- `iiko` (в перспективе): ежедневные продажи → `Transaction` (income) по соответствующим счетам (касса/эквайринг), с разнесением комиссий (expense, FINANCING или OPERATING, в зависимости от политики).

## Отчеты
- ДДС (кассовый метод): агрегирование по `paymentDate` с группировкой по видам деятельности (OPERATING/INVESTING/FINANCING), категориям и счетам. Переводы учитывать отдельно (внутренние перемещения, не влияют на общий приток/отток).
- ОПиУ (начисление): агрегирование по `accrualYear/month` (если не задан — месяц оплаты), с разрезом по категориям и видам деятельности.
- Балансы счетов: расчетный остаток на дату = opening + inflows − outflows (переводы влияют на счета, но не на консолидированный ДДС).

## UI (MVP)
- Счета: список с остатками; клик — леджер счета (фильтр по счету); CRUD счетов.
- Категории: древовидный список; у категории задаются тип (доход/расход) и `activity` (OPERATING/INVESTING/FINANCING); архивирование.
- Транзакции:
  - Вкладки: Расходы / Доходы / Переводы.
  - Фильтры: период (год/месяц), счет, категория, вид деятельности, метод, контрагент.
  - Таблица: дата, счет/категория, вид деятельности, сумма (выравнивание вправо, разрядность), комментарий.
  - Форма: 
    - Расход/Доход — дата оплаты, период начисления (год/месяц), счет, категория (подставляет activity), опциональный оверрайд activity, сумма, метод, контрагент, комментарий.
    - Перевод — дата, из счета, в счет, сумма, комментарий.
- Сверка (этап 2): загрузка/ввод выписки, автосопоставление, ручное сопоставление, закрытие периода сверки.

## Методика классификации (шпаргалка)
- OPERATING: выручка, возвраты, закупки сырья, зарплаты, аренда, коммунальные, услуги доставки/маркетинга.
- INVESTING: оборудование, ремонт, перестройка залов, долгосрочные вложения.
- FINANCING: кредиты (получение/погашение), проценты, вклады/изъятия собственника, комиссии банка за обслуживание кредитных продуктов.

## Отражение периодов
- Период начисления (ОПиУ) в транзакциях позволяет отличать «когда заработали/понесли расход» от «когда оплатили». Для зарплаты/аренд — период начисления = соответствующий месяц; оплата может быть в другом месяце.

## Реализация: по шагам (чек-лист)
1) Схема БД
   - [ ] Category: добавить `activity` (enum: OPERATING, INVESTING, FINANCING) и `type` (expense|income), parentId.
   - [ ] Transaction: создать модель с полями (см. раздел «Данные»), индексы по `paymentDate`, `accrualYear/month`, `accountId`, `categoryId`.
   - [ ] Миграции, генерация Prisma Client.
2) API
   - [ ] `/api/categories` — GET (дерево), POST, PATCH (включая смену activity и архивацию).
   - [ ] `/api/transactions` — GET (фильтры: kind, accountId, categoryId, period, activity), POST (expense/income), POST `/transactions/transfer`, DELETE.
   - [ ] Хуки интеграций: при POST `/api/payouts` — создавать связанную `Transaction(expense)` (категория «Зарплата», activity: OPERATING).
3) UI
   - [ ] Раздел «Финансы» → «Счета»: список, леджер (таблица транзакций по счету), создание счетов.
   - [ ] «Категории»: дерево, форма редактирования `type` и `activity`.
   - [ ] «Транзакции»: вкладки «Расходы/Доходы/Переводы», фильтры (включая `activity`), таблица и форма (с оверрайдом activity).
   - [ ] Форматирование сумм (рубли без копеек, разделители тысяч), выравнивание вправо.
4) Отчеты
   - [ ] ДДС: агрегаты по видам деятельности, категориям, счетам — таблица и свод.
   - [ ] ОПиУ: агрегаты по `accrualYear/month`, категориям, activity.
   - [ ] Балансы счетов на конец периода (проверка на переносы).
5) Сверка (этап 2)
   - [ ] Модель Statement/StatementLine, эндпоинты.
   - [ ] UI импорта и сопоставления, авто-match и ручной матч.
6) Интеграции и автоматизация
   - [ ] Payout → Transaction(expense) «Зарплата» (OPERATING).
   - [ ] iiko → Transaction(income) «Выручка», и комиссии эквайринга (expense, FINANCING/OPERATING по политике).
7) Миграции/бэкфилл
   - [ ] Проставить activity для стандартных категорий (по умолчанию OPERATING).
   - [ ] Конвертировать исторические `Payouts` в `Transactions` (опционально, флагом).

## Нефункциональные требования
- Производительность фильтрации/агрегаций по периодам и видам деятельности.
- Прозрачность и трассируемость: ссылка из транзакции на первичный документ (выплата, продажа и т.п.).
- Расширяемость: мультивалюта (позже), импорт выписок разных банков, бюджеты.

---
Если ок, в следующей итерации добавим модель `Category`, `Transaction` и минимальные экраны «Счета/Категории/Транзакции», с отчетами ДДС/ОПиУ на базе текущей БД.
