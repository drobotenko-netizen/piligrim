## Система управления зарплатами кафе — описание и чек‑лист V1

### Обзор
Одно кафе, SaaS‑готовая архитектура (мульти‑арендность на будущее), модуль расчёта зарплат с учётом смен, ставок, авансов, штрафов, премий, удержаний за еду, затрат на санкнижку, выделением официальной части и фиксацией выплат. Интерфейс на shadcn/ui. Файлы храним локально.

### Стек и архитектура
- **Приложение**: Next.js (App Router) + TypeScript
- **UI**: TailwindCSS + shadcn/ui (Headless + дизайн‑сборки)
- **Бэкенд**: серверные роуты Next.js (`app/api/*`)
- **БД/ORM**: PostgreSQL + Prisma (денежные поля `Decimal`)
- **Аутентификация**: NextAuth.js (Credentials)
- **RBAC**: роли в БД, middleware по префиксам маршрутов
- **Файлы**: локальная ФС `storage/uploads/` с метаданными в БД
- **Интеграции**: iiko (iikoCloud API) — импорт сотрудников, смен (часы), удержаний за еду
- **Логи/мониторинг**: базовые HTTP/ошибки, позже — Sentry

### Доменные сущности (упрощённо)
- **Tenant**: арендатор (сейчас один), для будущей мультиарендности
- **User**: учётка, роль, связка с сотрудником (опционально)
- **Role**: OWNER, ADMIN, MANAGER, ACCOUNTANT, CASHIER, EMPLOYEE
- **Position**: должность, базовая часовая ставка
- **Employee**: сотрудник, активность, должность, персональная ставка
- **Timesheet**: смена/табель (дата, начало/конец, часы, статус), разовая ставка
- **PayrollPeriod**: период расчёта (start/end, статусы: open → calculated → closed)
- **Accrual**: начисления (часы, премии, официальная часть), снепшоты
- **Deduction**: удержания (аванс, штраф, еда, санкнижка, прочее)
- **Payout**: факт выплаты (сумма, канал, дата)
- **FileObject**: метаданные локально загруженных файлов

### Правила расчёта (MVP)
1) Часы оплачиваемые = сумма часов подтверждённых смен в периоде.
2) Ставка за час: `override` в смене → персональная у сотрудника → базовая у должности.
3) Начисления = Σ(часы_i × ставка_i) + Σ(премии) + (официальная часть, если задана).
4) Удержания = авансы + штрафы + еда + санкнижка + прочие.
5) Итог к выплате = Начисления − Удержания. Официальная часть выделяется отдельной строкой.
6) После закрытия периода данные неизменяемы (только сторнирующие операции в новом периоде).

### Роли и доступ
- **OWNER/ADMIN**: полный доступ
- **MANAGER**: табели/смены, ставки, подтверждение смен
- **ACCOUNTANT**: периоды, начисления/удержания, расчёт, закрытие, экспорт
- **CASHIER**: реестр выплат, отметка «оплачено»
- **EMPLOYEE**: просмотр своих смен/расчётов

Маршруты (разделы):
- `/dashboard` — общий, виджеты зависят от роли
- `/admin/positions`, `/admin/employees`
- `/manager/timesheets`
- `/payroll/periods`, `/payroll/statement`
- `/cashier/payouts`
- `/employee/my-shifts`, `/employee/my-payroll`

### Локальное хранилище файлов
- Путь: `storage/uploads/{tenant_id}/{yyyy}/{mm}/{random}.{ext}` (при одном tenant — одна ветка)
- Метаданные: `FileObject(id, tenantId, path, originalName, mime, size, createdAt)`
- Доступ: `GET /api/uploads/:id` с проверкой прав (RBAC + принадлежность tenant)

### Интеграция с iiko (контур)
Цели v1:
- Синхронизация справочника сотрудников (и сопоставление с локальными `Employee`)
- Импорт отработанных часов (чек‑ин/чек‑аут или агрегированные смены) → `Timesheet`
- Импорт удержаний «еда сотрудника» → `Deduction(kind='meal')`

Компоненты:
- `integrations/iiko/client`: HTTP‑клиент iikoCloud API (авторизация, вызовы)
- `integrations/iiko/mappers`: преобразование ответов API к нашим моделям
- `integrations/iiko/sync`: сценарии синхронизации (сотрудники, смены, еда)
- Планировщик: периодические задачи (cron/через Node schedule/Background route)

Аутентификация к iiko:
- Секреты в переменных окружения: `IIKO_API_LOGIN`, `IIKO_API_KEY` (или аналог, согласно API вашей подписки)
- Получение access‑token и кэширование до истечения, авто‑обновление

Потоки данных (v1):
1) Employees: загрузить список сотрудников, сопоставить по email/тел/ФИО; новые — создавать как `Employee` (в статусе draft для сверки).
2) Timesheets: за период (например, по датам периода) загрузить часы/смены; агрегировать по сотруднику/дню; создавать/обновлять `Timesheet` (статус draft), менеджер утверждает.
3) Meal deductions: загрузить записи «питание персонала» (по отчётам/маркированным продажам); агрегировать суммы по сотруднику/периоду; создавать `Deduction(kind='meal')`.

Защита от дубликатов:
- Идемпотентные ключи по паре (внешний_id, дата/сотрудник/тип)
- Журналы синхронизации: `integration_logs` (успех/ошибки, окна синхронизации)

Ошибки и контроль качества:
- Сухой прогон (dry‑run) с отчетом, затем применить
- Сверка выборочно: 1–2 сотрудника, контроль часов и удержаний

Открытые моменты по iiko (уточнить в вашей подписке):
- Конкретные эндпоинты для чек‑ин/чек‑аут и «питание персонала» (варианты: события смен/учёта рабочего времени, отчёты по операциям/скидкам для персонала)
- Уникальные идентификаторы сотрудников для надёжного маппинга (GUID, табельный, телефон)

### API слои (ядро, серверные роуты Next.js)
- `/api/auth/*` — NextAuth (login/logout, session)
- `/api/admin/*` — CRUD должностей/сотрудников
- `/api/manager/timesheets/*` — CRUD/approve табелей, импорт CSV/iiko
- `/api/payroll/periods/*` — создать/рассчитать/закрыть, ведомость
- `/api/payroll/accruals`, `/api/payroll/deductions` — ручные операции
- `/api/cashier/payouts` — фиксация выплат
- `/api/uploads` — загрузка/выдача файлов
- `/api/integrations/iiko/*` — ручные триггеры/диагностика синка (под ролью ADMIN)

### Конфигурация окружения (минимум)
- `DATABASE_URL` — строка подключения Postgres
- `NEXTAUTH_SECRET`, `NEXTAUTH_URL`
- `IIKO_API_LOGIN`, `IIKO_API_KEY` (или эквиваленты для токена)

### Нефункциональные требования
- Денежные суммы — `Decimal(12,2)`; в коде — хранить копейки целым числом, если нужна точность вычислений
- Аудит: кто и когда создал/изменил (по сессии пользователя), история статусов периода
- Единообразные ошибки API (JSON‑ответы), валидация Zod на входе
- Импорт CSV как резерв к iiko

---

## Чек‑лист реализации V1

### 1) Инициализация проекта
- [ ] Создать Next.js (App Router), настроить TypeScript, ESLint/Prettier
- [ ] Подключить TailwindCSS и shadcn/ui, сгенерировать базовые компоненты (Button, Input, Dialog, Table, Form, Badge, Tabs)
- [ ] Настроить Prisma, подключить PostgreSQL, добавить скрипты миграций

### 2) Аутентификация и роли
- [ ] Внедрить NextAuth (Credentials): регистрация первого ADMIN, вход/выход
- [ ] Сессия JWT: прокидывать `role` и `tenantId`
- [ ] Middleware доступа по префиксам (`/admin`, `/manager`, `/payroll`, `/cashier`, `/employee`)
- [ ] Базовый `/dashboard` с ролевыми виджетами

### 3) Модели и миграции БД (Prisma)
- [ ] Модели: Tenant, User, Position, Employee, Timesheet, PayrollPeriod, Accrual, Deduction, Payout, FileObject
- [ ] Индексы по `tenantId`, внешние ключи, ограничения статусов
- [ ] Демо‑данные: одна должность, 1–2 сотрудника (без тест‑данных сверх минимума)

### 4) Администрирование
- [ ] CRUD `Position` (список, создание/редактирование, удаление с проверками)
- [ ] CRUD `Employee` (привязка к должности, персональная ставка, активность)

### 5) Табели/смены
- [ ] Создание/редактирование/удаление `Timesheet` (черновик)
- [ ] Подтверждение смен менеджером (draft → approved)
- [ ] Импорт CSV: дата, сотрудник, часы, разовая ставка

### 6) Период и расчёт
- [ ] CRUD `PayrollPeriod` (open → calculated → closed)
- [ ] Расчёт начислений «часы» по формуле ставки при статусе `calculated`
- [ ] Ручной ввод `Accrual(kind='bonus'|'official')`
- [ ] Ручной ввод `Deduction(kind='advance'|'fine'|'medbook'|'other')`
- [ ] Ведомость периода (свод и детализация по сотрудникам)
- [ ] Блокировка редактирования после `closed`

### 7) Выплаты
- [ ] Реестр выплат `Payout` (создание, отметка `paidAt`)
- [ ] Экспорт CSV реестра выплат

### 8) Удержания за еду и санкнижка
- [ ] Форма удержаний «еда» и «санкнижка», привязка к сотруднику/периоду
- [ ] Агрегация в ведомости

### 9) Файлы (локально)
- [ ] `POST /api/uploads` — загрузка файлов (с валидацией типа/размера), запись `FileObject`
- [ ] `GET /api/uploads/:id` — выдача с проверкой прав
- [ ] Секьюрность пути (исключить Directory Traversal), `.gitignore` для `storage/`

### 10) Интеграция с iiko (MVP)
- [ ] Клиент iikoCloud: получение токена, базовые вызовы, логирование
- [ ] Синк сотрудников: сопоставление с `Employee`, флаги «требует сверки»
- [ ] Импорт смен за период: создание/обновление `Timesheet` (draft), идемпотентность
- [ ] Импорт «еда сотрудника»: создание `Deduction(kind='meal')`, агрегирование по периоду
- [ ] Ручные триггеры синка (админ‑страница) и плановый запуск (cron/route)

### 11) UI/UX
- [ ] Ролевые разделы и навигация
- [ ] Таблицы (TanStack Table) + формы (React Hook Form + Zod)
- [ ] Страница ведомости с экспортом CSV

### 12) Качество и безопасность
- [ ] Валидация входных данных (Zod) во всех API
- [ ] Единый обработчик ошибок API
- [ ] Минимальные юнит‑тесты расчёта (формула ставки и агрегации)
- [ ] Документация по env и запуску проекта

### Критерии готовности V1
- [ ] Можно завести сотрудников/должности, внести смены, рассчитать период, добавить удержания/премии/официальную часть, получить ведомость и отметить выплаты
- [ ] Работает импорт CSV табелей
- [ ] Работает базовый синк с iiko: сотрудники, смены, удержания «еда»
- [ ] RBAC и доступы соблюдаются, файлы хранятся локально и защищены


