# –û—Ç—á–µ—Ç –æ –¥–µ–ø–ª–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Piligrim

## üéØ –¶–µ–ª—å –¥–µ–ø–ª–æ—è
–û–±–Ω–æ–≤–∏—Ç—å production –≤–µ—Ä—Å–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è Messaggio OTP –∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ Telegram-only –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é
- ‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ò–∑—É—á–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é (`docs/deploy.md`, `docs/cloud-git-deploy.md`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω SSH –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É `51.250.41.78`

### 2. –ö–æ–º–º–∏—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ git
- ‚úÖ –°–æ–∑–¥–∞–Ω –∫–æ–º–º–∏—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —É–¥–∞–ª–µ–Ω–∏—è Messaggio OTP
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ production —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ `git push prod main`

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ git hook
- ‚úÖ Git hook `post-receive` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
  - –û–±–Ω–æ–≤–∏–ª –∫–æ–¥ –≤ `/srv/piligrim/app/`
  - –°–æ–±—Ä–∞–ª –Ω–æ–≤—ã–µ Docker –æ–±—Ä–∞–∑—ã (`piligrim-web:latest`, `piligrim-api:latest`)
  - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —á–µ—Ä–µ–∑ `infra/docker-compose.yml`
  - –û—á–∏—Å—Ç–∏–ª –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ `.env` —Ñ–∞–π–ª–∞
- ‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã:
  - `AUTH_JWT_SECRET`: `dec0597d222b02043f5a8788292da45f6df35bb2d233f81b4436530bbb75f2aa`
  - `MAGIC_LINK_SECRET`: `08aeb25686968fcde24ccae2da7aa565b2550f7d44424fe85732e328d9e2c1c0`
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Messaggio:
  - `MESSAGGIO_API_KEY`
  - `MESSAGGIO_BASE_URL`
- ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω API –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

### 5. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- ‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏ —É–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (`api`, `web`)
- ‚úÖ –û—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (`infra-api-1`, `infra-web-1`)

## üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### API Endpoints
- ‚úÖ `https://piligrim.5-star-roi.ru/api/health` ‚Üí `{"ok":true}`
- ‚úÖ `https://piligrim.5-star-roi.ru/api/auth/_ping` ‚Üí `{"ok":true}`
- ‚úÖ `https://piligrim.5-star-roi.ru/api/auth/me` ‚Üí `{"error":"unauthorized"}` (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

### –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
- ‚úÖ `infra-api-1`: –∑–∞–ø—É—â–µ–Ω, –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —É—Å–ø–µ—à–Ω—ã–π —Å—Ç–∞—Ä—Ç
- ‚úÖ `infra-web-1`: –∑–∞–ø—É—â–µ–Ω, Next.js –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
- ‚úÖ Telegram polling: –∞–∫—Ç–∏–≤–µ–Ω (`[tg-polling] starting long polling‚Ä¶`)

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ Caddy –ø—Ä–æ–∫—Å–∏: —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã: –∞–∫—Ç–∏–≤–Ω—ã
- ‚úÖ –°–µ—Ç—å `proxy`: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–µ–ø–ª–æ—è

### –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- **–û–±—â–µ–µ –≤—Ä–µ–º—è**: ~30 –º–∏–Ω—É—Ç
- **Git push**: ~2 –º–∏–Ω—É—Ç—ã
- **–°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤**: ~5 –º–∏–Ω—É—Ç
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ env**: ~3 –º–∏–Ω—É—Ç—ã
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: ~5 –º–∏–Ω—É—Ç

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
- **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ**: 21
- **–°—Ç—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ**: 630
- **–°—Ç—Ä–æ–∫ —É–¥–∞–ª–µ–Ω–æ**: 1596
- **–ù–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤**: 4
- **–£–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤**: 1

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### –°–µ—Ä–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```
51.250.41.78 (Yandex Cloud)
‚îú‚îÄ‚îÄ Caddy (–ø—Ä–æ–∫—Å–∏ + SSL)
‚îú‚îÄ‚îÄ infra-api-1 (Express + Prisma)
‚îú‚îÄ‚îÄ infra-web-1 (Next.js)
‚îî‚îÄ‚îÄ SQLite database (volume)
```

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- ‚ùå **–£–¥–∞–ª–µ–Ω–æ**: Messaggio OTP, SMS –æ—Ç–ø—Ä–∞–≤–∫–∞
- ‚úÖ **–û—Å—Ç–∞–≤–ª–µ–Ω–æ**: Telegram –±–æ—Ç, Magic links, JWT —Ç–æ–∫–µ–Ω—ã

### API Endpoints
- `GET /api/health` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- `GET /api/auth/_ping` - –ø—Ä–æ–≤–µ—Ä–∫–∞ auth –º–æ–¥—É–ª—è
- `GET /api/auth/me` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- `POST /api/auth/dev-login` - DEV –≤—Ö–æ–¥
- `POST /api/auth/logout` - –≤—ã—Ö–æ–¥
- `GET /api/auth/magic/callback` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ magic links

## üöÄ –°—Ç–∞—Ç—É—Å: –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ** –ø–æ –∞–¥—Ä–µ—Å—É `https://piligrim.5-star-roi.ru`
2. **API –æ—Ç–≤–µ—á–∞–µ—Ç** –Ω–∞ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. **Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** –∞–∫—Ç–∏–≤–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ
4. **Magic links** –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
5. **–°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π** —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
6. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- **–°–µ–∫—Ä–µ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã** –Ω–∞ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–µ
- **Messaggio –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω—ã** –ø–æ–ª–Ω–æ—Å—Ç—å—é
- **HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç** —Å Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
- **CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω** –¥–ª—è production –¥–æ–º–µ–Ω–æ–≤

### üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π flow –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram
2. –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ admin –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã
4. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –∫–æ–º–∞–Ω–¥—ã

---

**–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω**: $(date)  
**–í–µ—Ä—Å–∏—è**: –±–µ–∑ Messaggio OTP, —Ç–æ–ª—å–∫–æ Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ Production ready
